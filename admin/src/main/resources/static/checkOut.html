<!DOCTYPE html>
<html>
    <head>
        <title>Checkout</title>
        <script>
            function confirmBooking() {
                let booking_ref = parseInt(document.getElementById('booking_ref').value);
                console.log(booking_ref);
                let name = document.getElementById('name').value;
                let email = document.getElementById('email').value;

                if(booking_ref && name && email) {
                    fetch('http://localhost:8083/bookings', { 
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            booking_ref: booking_ref,
                            name: name,
                            email: email
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.text();
                    })
                    .then(data => {
                        let bookingInfo;
                        try {
                            bookingInfo = JSON.parse(data); // Try to parse the data as JSON
                        } catch(e) {
                            // If an error is thrown in the try block, the data is not valid JSON (or not provided), and we can set it to null
                            bookingInfo = null;
                        }
                        if(bookingInfo === null) {
                            document.getElementById('bookingInfo').textContent = 'Booking not found.';
                        } else {
                            document.getElementById('bookingInfo').textContent = `Booking Info: ${JSON.stringify(bookingInfo)}`;

                            let checkoutButton = document.createElement('button');
                            checkoutButton.textContent = 'Confirm Checkout';
                            checkoutButton.onclick = function() {
                                checkout(bookingInfo);
                            };

                            document.getElementById('bookingInfo').appendChild(checkoutButton);
                        }
                    })
                    .catch(error => console.error('Error:', error));
                } else {
                    alert('Please fill out all fields before confirming booking.');
                }
            }

            function checkout(bookingInfo) {
                fetch('http://localhost:8083/checkout', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        booking_ref: parseInt(bookingInfo.booking_ref),
                        name: bookingInfo.name,
                        email: bookingInfo.email
                    })
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('checkoutConfirmation').textContent = `Checkout Confirmation: ${data.message}`;
                })
                .catch(error => console.error('Error:', error));
            }
        </script>
    </head>
    <body>
        <h1>Checkout</h1>
        <div>
            <label for="booking_ref">Booking ref:</label>
            <input type="text" id="booking_ref"><br>
            <label for="name">Name:</label>
            <input type="text" id="name"><br>
            <label for="email">Email:</label>
            <input type="text" id="email"><br>
            <button onclick="confirmBooking()">Confirm Booking</button>
        </div>
        <div id="bookingInfo"></div>
        <div id="checkoutConfirmation"></div>
    </body>
</html>
